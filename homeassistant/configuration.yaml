# Configure a default setup, default_config includes these items - https://www.home-assistant.io/integrations/default_config
#default_config:
automation: !include automations.yaml
cloud:
  alexa:
    filter:
      include_domains:
        - climate
        - light
        - switch
      exclude_entities:
        - light.configuration_tool_1
        - light.bedroom_left
        - light.bedroom_right
        - light.hallway_center
        - light.hallway_door
        - light.hallway_kitchen
        - switch.adguard_filtering
        - switch.adguard_parental_control
        - switch.adguard_protection
        - switch.adguard_safe_browsing
        - switch.adguard_safe_search
  google_actions:
    filter:
      include_domains:
        - climate
        - light
        - switch
      exclude_entities:
        - light.configuration_tool_1
        - light.bedroom_left
        - light.bedroom_right
        - light.hallway_center
        - light.hallway_door
        - light.hallway_kitchen
        - switch.adguard_filtering
        - switch.adguard_parental_control
        - switch.adguard_protection
        - switch.adguard_safe_browsing
        - switch.adguard_safe_search
config:
frontend:
history:
#logbook:
#map:
mobile_app:
#person:
script: !include scripts.yaml
ssdp:
sun:
system_health:
updater:
  include_used_components: true
  reporting: false
zeroconf:
#zone:

logger:
  default: info

apple_tv:
  host: !secret atv_livingroom_ip
  login_id: !secret atv_livingroom_login_key
  start_off: true

camera:
  - platform: environment_canada
    name: radar
    station: WSO
  - platform: generic
    name: jet_stream
    content_type: image/gif
    still_image_url: https://s.w-x.co/staticmaps/wu/wu/jetstream1200_cur/conus/animate.png
  - platform: generic
    name: YTZ
    still_image_url: http://www.metcam.navcanada.ca/dawc_images/wxcam/CYTZ/CYTZ_N-full-e.jpeg
  - platform: generic
    name: YYZ
    still_image_url: https://511on.ca/map/Cctv/loc33--2

cast:
  media_player:
      - host: !secret ghomem1_ip

clean_up_snapshots_service:
  host: !secret server_port_url
  token: !secret long_lived_token
  number_of_snapshots_to_keep: 7

emulated_hue:
  host_ip: !secret emulated_hue_ip
  expose_by_default: false
  entities:
    light.floor:
      name: floor
      hidden: false
    light.led:
      name: led
      hidden: false
    switch.kitchen:
      name: kitchen
      hidden: false

ffmpeg:

glances:
  - host: !secret server_ip

group: !include groups.yaml

homeassistant:
  customize: !include customize.yaml

homekit:
  auto_start: true
  filter:
    include_domains:
      - climate
      - light
      - switch

media_player:
  - platform: androidtv
    name: nvidia_shield
    host: !secret shield_ip

notify:
  - name: alimustakim
    platform: twitter
    consumer_key: !secret alimustakim_consumer_key
    consumer_secret: !secret alimustakim_consumer_secret_key
    access_token: !secret alimustakim_access_token_key
    access_token_secret: !secret alimustakim_access_token_secret_key
  - name: forwardcomputers
    platform: twitter
    consumer_key: !secret forwardcomputers_consumer_key
    consumer_secret: !secret forwardcomputers_consumer_secret_key
    access_token: !secret forwardcomputers_access_token_key
    access_token_secret: !secret forwardcomputers_access_token_secret_key
  
panel_iframe:
  adguard:
     title: Adguard
     icon: mdi:shield-check
     url: !secret adguard_url
  glances:
     title: Glances
     icon: mdi:speedometer
     url: !secret glances_url
  portainer:
    title: Portainer
    icon: mdi:docker
    url: !secret portainer_url

plant:
  Coleus:
    sensors:
      battery: sensor.kitchen_battery
      brightness: sensor.kitchen_light_intensity
      conductivity: sensor.kitchen_conductivity
      moisture: sensor.kitchen_moisture
      temperature: sensor.kitchen_temperature
    check_days: 3
    min_battery: 15
    min_brightness: 3000
    max_brightness: 70000
    min_conductivity: 350
    max_conductivity: 2000
    min_moisture: 15
    max_moisture: 60
    min_temperature: 10
    max_temperature: 35

python_script:

recorder:
  exclude:
    domains:
      - automation
      - binary_sensor
      - camera
      - device_tracker
      - media_player
      - person
      - plant
      - remote
      - script
      - weather
      - zone
    entities:
      - sensor.97north
      - sensor.adguard_average_processing_speed
      - sensor.adguard_dns_queries
      - sensor.adguard_dns_queries_blocked_ratio
      - sensor.adguard_parental_control_blocked
      - sensor.adguard_safe_browsing_blocked
      - sensor.adguard_safe_searches_enforced
      - sensor.activity
      - sensor.activity_2
      - sensor.advisories
      - sensor.average_active_pace
      - sensor.average_active_pace_2
      - sensor.battery_level
      - sensor.battery_level_2
      - sensor.battery_level_3
      - sensor.battery_state
      - sensor.battery_state_2
      - sensor.battery_state_3
      - sensor.bssid
      - sensor.bssid_2
      - sensor.bssid_3
      - sensor.connection_type
      - sensor.connection_type_2
      - sensor.connection_type_3
      - sensor.distance
      - sensor.distance_2
      - sensor.distro
      - sensor.docker_github_version
      - sensor.docker_version
      - sensor.ec_1_icon
      - sensor.ec_1_name
      - sensor.ec_1_summary
      - sensor.ec_1_summary_text
      - sensor.ec_2_icon
      - sensor.ec_2_name
      - sensor.ec_2_summary
      - sensor.ec_2_summary_text
      - sensor.ec_3_icon
      - sensor.ec_3_name
      - sensor.ec_3_summary
      - sensor.ec_3_summary_text
      - sensor.ec_4_icon
      - sensor.ec_4_name
      - sensor.ec_4_summary
      - sensor.ec_4_summary_text
      - sensor.ec_5_icon
      - sensor.ec_5_name
      - sensor.ec_5_summary
      - sensor.ec_5_summary_text
      - sensor.ec_6_icon
      - sensor.ec_6_name
      - sensor.ec_6_summary
      - sensor.ec_6_summary_text
      - sensor.ec_current_icon
      - sensor.ec_current_summary
      - sensor.ec_current_summary_text
      - sensor.endings
      - sensor.floors_ascended
      - sensor.floors_ascended_2
      - sensor.floors_descended
      - sensor.floors_descended_2
      - sensor.forecast
      - sensor.geocoded_location
      - sensor.geocoded_location_2
      - sensor.geocoded_location_3
      - sensor.glances_acpitz_1_temp
      - sensor.glances_acpitz_1_temp_2
      - sensor.glances_containers_active
      - sensor.glances_containers_active_2
      - sensor.glances_containers_cpu_used
      - sensor.glances_containers_cpu_used_2
      - sensor.glances_containers_ram_used
      - sensor.glances_containers_ram_used_2
      - sensor.glances_core_0_temp
      - sensor.glances_core_0_temp_2
      - sensor.glances_core_1_temp
      - sensor.glances_core_1_temp_2
      - sensor.glances_cpu_load
      - sensor.glances_cpu_load_2
      - sensor.glances_cpu_used
      - sensor.glances_cpu_used_2
      - sensor.glances_data_free
      - sensor.glances_data_free_2
      - sensor.glances_data_used
      - sensor.glances_data_used_2
      - sensor.glances_data_used_percent
      - sensor.glances_data_used_percent_2
      - sensor.glances_etc_hostname_free
      - sensor.glances_etc_hostname_used
      - sensor.glances_etc_hostname_used_percent
      - sensor.glances_etc_hosts_free
      - sensor.glances_etc_hosts_used
      - sensor.glances_etc_hosts_used_percent
      - sensor.glances_etc_resolv_conf_free
      - sensor.glances_etc_resolv_conf_used
      - sensor.glances_etc_resolv_conf_used_percent
      - sensor.glances_glances_conf_free
      - sensor.glances_glances_conf_used
      - sensor.glances_glances_conf_used_percent
      - sensor.glances_iwlwifi_1_temp
      - sensor.glances_iwlwifi_1_temp_2
      - sensor.glances_package_id_0_temp
      - sensor.glances_package_id_0_temp_2
      - sensor.glances_pch_skylake_1_temp
      - sensor.glances_pch_skylake_1_temp_2
      - sensor.glances_ram_free
      - sensor.glances_ram_free_2
      - sensor.glances_ram_used
      - sensor.glances_ram_used_2
      - sensor.glances_ram_used_percent
      - sensor.glances_ram_used_percent_2
      - sensor.glances_running
      - sensor.glances_running_2
      - sensor.glances_sleeping
      - sensor.glances_sleeping_2
      - sensor.glances_swap_free
      - sensor.glances_swap_free_2
      - sensor.glances_swap_used
      - sensor.glances_swap_used_2
      - sensor.glances_swap_used_percent
      - sensor.glances_swap_used_percent_2
      - sensor.glances_thread
      - sensor.glances_thread_2
      - sensor.glances_total
      - sensor.glances_total_2
      - sensor.hacs
      - sensor.hass_github_version
      - sensor.hass_uptime
      - sensor.icon_code
      - sensor.in_belize
      - sensor.installed_version
      - sensor.kernel_version
      - sensor.last_update_trigger
      - sensor.last_update_trigger_2
      - sensor.last_update_trigger_3
      - sensor.lenovo_tb_8704f_battery_level
      - sensor.lenovo_tb_8704f_geocoded_location
      - sensor.lenovo_tb_8704f_wifi_connection
      - sensor.nas_name
      - sensor.nas_serial
      - sensor.nas_uptime
      - sensor.office_ups_model
      - sensor.office_ups_serial_number
      - sensor.os
      - sensor.powerliving_bytes_received
      - sensor.powerliving_bytes_sent
      - sensor.powerliving_kib_sec_received
      - sensor.powerliving_kib_sec_sent
      - sensor.powerliving_packets_received
      - sensor.powerliving_packets_sec_received
      - sensor.powerliving_packets_sec_sent
      - sensor.powerliving_packets_sent
      - sensor.printer_drum
      - sensor.printer_drum_max
      - sensor.printer_drum_now
      - sensor.printer_drum_pct
      - sensor.printer_fw
      - sensor.printer_latest_firmware
      - sensor.printer_model
      - sensor.printer_pages
      - sensor.printer_sn
      - sensor.printer_toner
      - sensor.printer_toner_max
      - sensor.printer_toner_now
      - sensor.printer_toner_pct
      - sensor.printer_uptime
      - sensor.processor_use
      - sensor.router_cpu_load
      - sensor.router_filename
      - sensor.router_id
      - sensor.router_latest_firmware
      - sensor.router_mem_used
      - sensor.router_model
      - sensor.router_ram
      - sensor.router_release
      - sensor.router_revision
      - sensor.router_target
      - sensor.router_uptime
      - sensor.san_francisco
      - sensor.server_uptime
      - sensor.sim_1
      - sensor.sim_1_2
      - sensor.sim_2
      - sensor.ssid
      - sensor.ssid_2
      - sensor.ssid_3
      - sensor.statements
      - sensor.steps
      - sensor.steps_2
      - sensor.synology_dsm_cpu_load_total
      - sensor.synology_dsm_memory_usage_real
      - sensor.synology_dsm_status_smart_sda
      - sensor.synology_dsm_status_smart_sdb
      - sensor.synology_dsm_status_volume_1
      - sensor.synology_dsm_volume_used_volume_1
      - sensor.sys_current_firmware
      - sensor.sys_latest_firmware
      - sensor.sys_name
      - sensor.tendency
      - sensor.time
      - sensor.time_utc
      - sensor.ttc_97
      - sensor.uk
      - sensor.uptime_minutes
      - sensor.warnings
      - sensor.watches
      - sun.sun
      - switch.adguard_filtering
      - switch.adguard_parental_control
      - switch.adguard_protection
      - switch.adguard_safe_browsing
      - switch.adguard_safe_search
  purge_keep_days: 7

remote:
  - platform: harmony
    name: Harmony
    host: !secret harmonyhub_ip

shell_command:
  clean_printer: !secret printer_cleaning_mode_url
  download_ec_forecast_toronto: /usr/bin/curl -L -s --retry 3 --output /tmp/toronto.xml https://dd.weather.gc.ca/citypage_weather/xml/ON/s0000458_e.xml
  download_router_firmware: /usr/bin/curl -L -s --retry 3 --output /opt/filer/Firmware/openwrt-{{states('sensor.router_latest_firmware')}}-{{states('sensor.router_target')}}-generic-{{states('sensor.router_filename')}} https://downloads.openwrt.org/releases/{{states('sensor.router_latest_firmware')}}/targets/{{states('sensor.router_target')}}/generic/openwrt-{{states('sensor.router_latest_firmware')}}-{{states('sensor.router_target')}}-generic-{{states('sensor.router_filename')}}
  download_printer_firmware: /usr/bin/curl -L -s --retry 3 --output /opt/filer/Firmware/HP_LaserJet_Pro_MFP_M130_M132_Ultra_MFP_M134_Printer_{{states('sensor.printer_latest_firmware')}}.rfu ftp://ftp.hp.com/pub/networking/software/pfirmware/HP_LaserJet_Pro_MFP_M130_M132_Ultra_MFP_M134_Printer_{{states('sensor.printer_latest_firmware')}}.rfu
  download_system_firmware: /usr/bin/curl -L -s --retry 3 --output /opt/filer/Firmware/NUC7i5BNK-BN{{states('sensor.sys_latest_firmware')}}.bio https://downloadmirror.intel.com/29347/eng/BN{{states('sensor.sys_latest_firmware')}}.bio
  mount_filer: !secret mount_filer_share

speedtestdotnet:
  scan_interval:
    minutes: 30
  monitored_conditions:
    - ping
    - download
    - upload
  server_id: 2565
# Teksavvy ---^

weather:
  - platform: environment_canada
    station: ON/s0000458

sensor:
  - platform: seventeentrack
    username: !secret seventeen_username
    password: !secret seventeen_password
  - platform: scrape
    name: pollen
    resource: https://www.theweathernetwork.com/ca/forecasts/pollen/ontario/toronto
    select: "#allergy_conditions > div.allergy-summary > div.summary-item.pollen > div.allergy-level"
    scan_interval: 3600
  - platform: scrape
    name: mold
    resource: https://www.theweathernetwork.com/ca/forecasts/pollen/ontario/toronto
    select: "#allergy_conditions > div.allergy-summary > div.summary-item.mold > div.allergy-level"
    scan_interval: 3600
  - platform: command_line
    name: flu
    command: "/usr/bin/curl -L \"https://www.theweathernetwork.com/ca/health/ontario/toronto\" 2>&1 | awk -F '[ \"]' '/activity-colour/ {print toupper( substr( $4, 1, 1 ) ) substr( $4, 2 )}'"
    scan_interval: 3600
  - platform: command_line
    name: ec_current_summary_text
    command: "python3 -c \"import lxml.etree; doc=lxml.etree.parse('/tmp/toronto.xml'); rev=doc.xpath('//currentConditions/condition/text()')[0]; print(rev[:250])\""
  - platform: command_line
    name: ec_current_icon
    command: "python3 -c \"import lxml.etree; doc=lxml.etree.parse('/tmp/toronto.xml'); rev=doc.xpath('//currentConditions/iconCode/text()'); print(*rev)\""
  - platform: command_line
    name: ec_1_name
    command: "python3 -c \"import lxml.etree; doc=lxml.etree.parse('/tmp/toronto.xml'); rev=doc.xpath('//forecastGroup/forecast[1]/period/text()'); print(*rev)\""
  - platform: command_line
    name: ec_1_icon
    command: "python3 -c \"import lxml.etree; doc=lxml.etree.parse('/tmp/toronto.xml'); rev=doc.xpath('//forecastGroup/forecast[1]/abbreviatedForecast/iconCode/text()'); print(*rev)\""
  - platform: command_line
    name: ec_1_summary_text
    command: "python3 -c \"import lxml.etree; doc=lxml.etree.parse('/tmp/toronto.xml'); rev=doc.xpath('//forecastGroup/forecast[1]/textSummary/text()')[0]; print(rev[:250])\""
  - platform: command_line
    name: ec_2_name
    command: "python3 -c \"import lxml.etree; doc=lxml.etree.parse('/tmp/toronto.xml'); rev=doc.xpath('//forecastGroup/forecast[2]/period/text()'); print(*rev)\""
  - platform: command_line
    name: ec_2_icon
    command: "python3 -c \"import lxml.etree; doc=lxml.etree.parse('/tmp/toronto.xml'); rev=doc.xpath('//forecastGroup/forecast[2]/abbreviatedForecast/iconCode/text()'); print(*rev)\""
  - platform: command_line
    name: ec_2_summary_text
    command: "python3 -c \"import lxml.etree; doc=lxml.etree.parse('/tmp/toronto.xml'); rev=doc.xpath('//forecastGroup/forecast[2]/textSummary/text()')[0]; print(rev[:250])\""
  - platform: command_line
    name: ec_3_name
    command: "python3 -c \"import lxml.etree; doc=lxml.etree.parse('/tmp/toronto.xml'); rev=doc.xpath('//forecastGroup/forecast[3]/period/text()'); print(*rev)\""
  - platform: command_line
    name: ec_3_icon
    command: "python3 -c \"import lxml.etree; doc=lxml.etree.parse('/tmp/toronto.xml'); rev=doc.xpath('//forecastGroup/forecast[3]/abbreviatedForecast/iconCode/text()'); print(*rev)\""
  - platform: command_line
    name: ec_3_summary_text
    command: "python3 -c \"import lxml.etree; doc=lxml.etree.parse('/tmp/toronto.xml'); rev=doc.xpath('//forecastGroup/forecast[3]/textSummary/text()')[0]; print(rev[:250])\""
  - platform: command_line
    name: ec_4_name
    command: "python3 -c \"import lxml.etree; doc=lxml.etree.parse('/tmp/toronto.xml'); rev=doc.xpath('//forecastGroup/forecast[4]/period/text()'); print(*rev)\""
  - platform: command_line
    name: ec_4_icon
    command: "python3 -c \"import lxml.etree; doc=lxml.etree.parse('/tmp/toronto.xml'); rev=doc.xpath('//forecastGroup/forecast[4]/abbreviatedForecast/iconCode/text()'); print(*rev)\""
  - platform: command_line
    name: ec_4_summary_text
    command: "python3 -c \"import lxml.etree; doc=lxml.etree.parse('/tmp/toronto.xml'); rev=doc.xpath('//forecastGroup/forecast[4]/textSummary/text()')[0]; print(rev[:250])\""
  - platform: command_line
    name: ec_5_name
    command: "python3 -c \"import lxml.etree; doc=lxml.etree.parse('/tmp/toronto.xml'); rev=doc.xpath('//forecastGroup/forecast[5]/period/text()'); print(*rev)\""
  - platform: command_line
    name: ec_5_icon
    command: "python3 -c \"import lxml.etree; doc=lxml.etree.parse('/tmp/toronto.xml'); rev=doc.xpath('//forecastGroup/forecast[5]/abbreviatedForecast/iconCode/text()'); print(*rev)\""
  - platform: command_line
    name: ec_5_summary_text
    command: "python3 -c \"import lxml.etree; doc=lxml.etree.parse('/tmp/toronto.xml'); rev=doc.xpath('//forecastGroup/forecast[5]/textSummary/text()')[0]; print(rev[:250])\""
  - platform: command_line
    name: ec_6_name
    command: "python3 -c \"import lxml.etree; doc=lxml.etree.parse('/tmp/toronto.xml'); rev=doc.xpath('//forecastGroup/forecast[6]/period/text()'); print(*rev)\""
  - platform: command_line
    name: ec_6_icon
    command: "python3 -c \"import lxml.etree; doc=lxml.etree.parse('/tmp/toronto.xml'); rev=doc.xpath('//forecastGroup/forecast[6]/abbreviatedForecast/iconCode/text()'); print(*rev)\""
  - platform: command_line
    name: ec_6_summary_text
    command: "python3 -c \"import lxml.etree; doc=lxml.etree.parse('/tmp/toronto.xml'); rev=doc.xpath('//forecastGroup/forecast[6]/textSummary/text()')[0]; print(rev[:250])\""

  - platform: environment_canada
    station: ON/s0000458

  - platform: systemmonitor
    resources:
      - type: processor_use
  - platform: command_line
    command: python3 -c "import requests; print(requests.get('http://localhost:61208/api/3/system').json()['os_name'])"
    name: OS
    scan_interval: 86400
  - platform: command_line
    command: python3 -c "import requests; print(requests.get('http://localhost:61208/api/3/system').json()['linux_distro'])"
    name: Distro
    scan_interval: 86400
  - platform: command_line
    command: python3 -c "import requests; print(requests.get('http://localhost:61208/api/3/system').json()['os_version'])"
    name: Kernel Version
    scan_interval: 86400
  - platform: command_line
    command: python3 -c "import requests; print(requests.get('http://localhost:61208/api/3/docker').json()['version']['Components'][0]['Version'])"
    name: Docker Version
    scan_interval: 86400
  - platform: command_line
    name: sys_name
    command: awk '{ printf "%s ", $1 ;next ; print "%s" $1}' /sys/class/dmi/id/product_family /sys/class/dmi/id/product_name
    scan_interval: 86400
  - platform: command_line
    name: sys_current_firmware
    command: awk -F. '{print $3}' <  /sys/class/dmi/id/bios_version
    scan_interval: 86400
  - platform: command_line
    name: sys_latest_firmware
    command: python3 -c "import lxml.html; import requests; html=requests.get('https://downloadcenter.intel.com/search?keyword=NUC7i5BNK+bios'); doc=lxml.html.fromstring(html.text); rev=doc.xpath('//*[@id=\"search-results\"]/tbody/tr/td[4]/text()')[0]; print(rev)"
    scan_interval: 3600
  - platform: snmp
    name: server_uptime
    host: !secret server_ip
    baseoid: 1.3.6.1.2.1.25.1.1.0
    accept_errors: true
    scan_interval: 30
    value_template: >-
        {% set uptime = float(value) / 100 %}
        {% set updays = (uptime / 86400) | round(0, "floor") %}
        {% set uphours = uptime | timestamp_custom('%-H:%-M:%-S', false) | regex_replace('^0:','') %}
        {% if updays == 0 %}
            {{- uphours -}}
        {% elif updays == 1 %}
            {{- updays ~ " Day, " ~ uphours -}}
        {% else %}
            {{- updays ~ " Days, " ~ uphours -}}
        {% endif %}
  - platform: rest
    scan_interval: 3600
    name: docker_github_version
    resource: https://api.github.com/repos/docker/docker-ce/releases/latest
    username: !secret github_user
    password: !secret github_token
    authentication: basic
    value_template: '{{ value_json.name }}'
    headers:
      Accept: application/vnd.github.v3+json
      Content-Type: application/json
      User-Agent: Home Assistant REST sensor

  - platform: version
    name: installed_version
  - platform: uptime
    name: uptime_minutes
    unit_of_measurement: minutes
    scan_interval: 30
  - platform: template
    sensors:
      hass_uptime:
        value_template: >-
            {% set uptime = states('sensor.uptime_minutes') | float * 60 %}
            {% set updays = (uptime / 86400) | round(0, "floor") %}
            {% set uphours = uptime | timestamp_custom('%-H:%-M:%-S', false) | regex_replace('^0:','') %}
            {% if updays == 0 %}
                {{- uphours -}}
            {% elif updays == 1 %}
                {{- updays ~ " Day, " ~ uphours -}}
            {% else %}
                {{- updays ~ " Days, " ~ uphours -}}
            {% endif %}
  - platform: rest
    scan_interval: 3600
    name: hass_github_version
    resource: https://api.github.com/repos/home-assistant/home-assistant/releases/latest
    username: !secret github_user
    password: !secret github_token
    authentication: basic
    value_template: '{{ value_json.name }}'
    headers:
      Accept: application/vnd.github.v3+json
      Content-Type: application/json
      User-Agent: Home Assistant REST sensor

  - platform: snmp
    name: router_id
    host: !secret router_ip
    baseoid: 1.3.6.1.3.19811018.1.101.1
    accept_errors: true
    scan_interval: 86400
  - platform: snmp
    name: router_release
    host: !secret router_ip
    baseoid: 1.3.6.1.3.19811018.2.101.1
    accept_errors: true
    scan_interval: 3600
  - platform: snmp
    name: router_revision
    host: !secret router_ip
    baseoid: 1.3.6.1.3.19811018.3.101.1
    accept_errors: true
    scan_interval: 3600
  - platform: snmp
    name: router_model
    host: !secret router_ip
    baseoid: 1.3.6.1.3.19811018.4.101.1
    accept_errors: true
    scan_interval: 86400
  - platform: snmp
    name: router_target
    host: !secret router_ip
    baseoid: 1.3.6.1.3.19811018.5.101.1
    accept_errors: true
    scan_interval: 86400
  - platform: snmp
    name: router_filename
    host: !secret router_ip
    baseoid: 1.3.6.1.3.19811018.6.101.1
    accept_errors: true
    scan_interval: 86400
  - platform: command_line
    name: router_latest_firmware
    command: python3 -c "import lxml.html; import requests; html=requests.get('https://downloads.openwrt.org'); doc=lxml.html.fromstring(html.text); rev=doc.xpath('/html/body/div/ul[1]/li/strong/a/text()')[0]; print(rev.split()[-1])"
  - platform: snmp
    name: router_uptime
    host: !secret router_ip
    baseoid: 1.3.6.1.2.1.25.1.1.0
    accept_errors: true
    scan_interval: 30
    value_template: >-
        {% set uptime = float(value) / 100 %}
        {% set updays = (uptime / 86400) | round(0, "floor") %}
        {% set uphours = uptime | timestamp_custom('%-H:%-M:%-S', false) | regex_replace('^0:','') %}
        {% if updays == 0 %}
            {{- uphours -}}
        {% elif updays == 1 %}
            {{- updays ~ " Day, " ~ uphours -}}
        {% else %}
            {{- updays ~ " Days, " ~ uphours -}}
        {% endif %}
  - platform: snmp
    name: router_cpu_load
    host: !secret router_ip
    baseoid: 1.3.6.1.4.1.2021.11.11.0
    accept_errors: true
    scan_interval: 30
    unit_of_measurement: '%'
    value_template: >-
        {% set load = 100 - value | int %}
        {{- load -}}
  - platform: snmp
    name: router_ram
    host: !secret router_ip
    baseoid: 1.3.6.1.4.1.2021.4.5.0
    accept_errors: true
    scan_interval: 30
    value_template: >-
        {% set ram = (value.split(" ")[0]) | float %}
        {{- ram -}}
  - platform: snmp
    name: router_mem_used
    host: !secret router_ip
    baseoid: 1.3.6.1.4.1.2021.4.6.0
    accept_errors: true
    scan_interval: 30
    unit_of_measurement: '%'
    value_template: >-
        {% set free = (value.split(" ")[0]) | float %}
        {% set total = states('sensor.router_ram') | float %}
        {% set used = ((total - free) / total * 100) | round(0, "floor") %}
        {{- used -}}

  - platform: command_line
    name: printer_latest_firmware
    command: python3 -c "import ftplib; ftp=ftplib.FTP('ftp.hp.com');ftp.login();ftp.cwd('/pub/networking/software/pfirmware');ftpd=ftp.nlst(); name='HP_LaserJet_Pro_MFP_M130_M132_Ultra_MFP_M134_Printer_'; found=[i for i in ftpd if name in i]; print (found[-1][found[-1].find(name)+len(name):found[-1].rfind('.rfu')])"
  - platform: snmp
    name: printer_model
    host: !secret laser_ip
    baseoid: 1.3.6.1.4.1.11.2.3.9.4.2.1.1.3.2.0
    accept_errors: true
    scan_interval: 86400
  - platform: snmp
    name: printer_sn
    host: !secret laser_ip
    baseoid: 1.3.6.1.4.1.11.2.3.9.4.2.1.1.3.3.0
    accept_errors: true
    scan_interval: 86400
  - platform: snmp
    name: printer_fw
    host: !secret laser_ip
    baseoid: 1.3.6.1.4.1.11.2.3.9.4.2.1.1.3.5.0
    accept_errors: true
    scan_interval: 3600
  - platform: snmp
    name: printer_toner
    host: !secret laser_ip
    baseoid: 1.3.6.1.2.1.43.11.1.1.6.1.1
    accept_errors: true
    scan_interval: 86400
  - platform: snmp
    name: printer_toner_now
    host: !secret laser_ip
    baseoid: 1.3.6.1.2.1.43.11.1.1.9.1.1
    accept_errors: true
    scan_interval: 1800
  - platform: snmp
    name: printer_toner_max
    host: !secret laser_ip
    baseoid: 1.3.6.1.2.1.43.11.1.1.8.1.1
    accept_errors: true
    scan_interval: 86400
  - platform: template
    sensors:
      printer_toner_pct:
        unit_of_measurement: '%'
        value_template: >-
            {% set m = float(states('sensor.printer_toner_max')) %}
            {% set n = float(states('sensor.printer_toner_now')) %}
            {% if m == 'unknown' %} {% set m = 0 %}  {% endif %}
            {% if n == 'unknown' %} {% set n = 0 %}  {% endif %}
            {% if m != 0 -%}
                {{ ((n / m) * 100) | round(0) }}
            {% else %}
                {{ 0 }}
            {% endif %}
  - platform: snmp
    name: printer_drum
    host: !secret laser_ip
    baseoid: 1.3.6.1.2.1.43.11.1.1.6.1.5
    accept_errors: true
    scan_interval: 86400
  - platform: snmp
    name: printer_drum_now
    host: !secret laser_ip
    baseoid: 1.3.6.1.2.1.43.11.1.1.9.1.5
    accept_errors: true
    scan_interval: 1800
  - platform: snmp
    name: printer_drum_max
    host: !secret laser_ip
    baseoid: 1.3.6.1.2.1.43.11.1.1.8.1.5
    accept_errors: true
    scan_interval: 86400
  - platform: template
    sensors:
      printer_drum_pct:
        unit_of_measurement: '%'
        value_template: >-
            {% set m = float(states('sensor.printer_drum_max')) %}
            {% set n = float(states('sensor.printer_drum_now')) %}
            {% if m == 'unknown' %} {% set m = 0 %}  {% endif %}
            {% if n == 'unknown' %} {% set n = 0 %}  {% endif %}
            {% if m != 0 -%}
                {{ ((n / m) * 100) | round(0) }}
            {% else %}
                {{ 0 }}
            {% endif %}
  - platform: snmp
    name: printer_pages
    host: !secret laser_ip
    baseoid: 1.3.6.1.2.1.43.10.2.1.4.1.1
    accept_errors: true
    scan_interval: 1800
  - platform: snmp
    name: printer_uptime
    host: !secret laser_ip
    baseoid: 1.3.6.1.2.1.1.3.0
    accept_errors: true
    scan_interval: 30
    value_template: >-
        {% set uptime = float(value) / 100 %}
        {% set updays = (uptime / 86400) | round(0, "floor") %}
        {% set uphours = uptime | timestamp_custom('%-H:%-M:%-S', false) | regex_replace('^0:','') %}
        {% if updays == 0 %}
            {{- uphours -}}
        {% elif updays == 1 %}
            {{- updays ~ " Day, " ~ uphours -}}
        {% else %}
            {{- updays ~ " Days, " ~ uphours -}}
        {% endif %}

  - platform: template
    sensors:
      temperature_in:
        friendly_name: Inside temperature
        unit_of_measurement: '°C'
        value_template: "{{ state_attr('climate.thermostat', 'current_temperature') }}"
      humidity_in:
        friendly_name: Inside humidity
        unit_of_measurement: '%'
        value_template: "{{ state_attr('climate.thermostat', 'current_humidity') }}"
      feels_like:
        friendly_name: Feels like
        unit_of_measurement: '°C'
        value_template: >-
          {% if not is_state('sensor.wind_chill', 'unknown') %}
            {{ states('sensor.wind_chill') }}
          {% elif not is_state('sensor.humidex', 'unknown') %}
            {{ states('sensor.humidex') }}
          {% else %}
            {{ states('sensor.temperature') }}
          {% endif %}

  - platform: template
    sensors:
      sun_next_rising:
        value_template: "{{ as_timestamp(state_attr('sun.sun', 'next_rising')) | timestamp_custom(' %-I:%M %p') }}"
      sun_next_setting:
        value_template: "{{ as_timestamp(state_attr('sun.sun', 'next_setting')) | timestamp_custom(' %-I:%M %p') }}"

  - platform: time_date
    display_options:
      - 'time'
      - 'time_utc'
  - platform: worldclock
    name: UK
    time_zone: Europe/London
  - platform: worldclock
    name: San Francisco
    time_zone: America/Los_Angeles

  - platform: nut
    name: Office UPS
    username: ups
    host: !secret synology_ip
    resources:
      - ups.status.display
      - ups.load
      - battery.runtime
      - battery.charge
      - ups.status
  - platform: template
    sensors:
      office_ups_battery_runtime_mins:
        unit_of_measurement: 'min'
        value_template: "{{ float(states('sensor.office_ups_battery_runtime')) / 60 | round(2)}}"
      office_ups_model:
        value_template: "Back-UPS BX1500G"
      office_ups_serial_number:
        value_template: "3B1106X32967"
  - platform: template
    sensors:
      office_ups_status_data_short:
        value_template: "{{ states('sensor.office_ups_status_data').split(' ')[0] }}"

  - platform: synologydsm
    host: !secret synology_ip
    username: !secret synology_user_name
    password: !secret synology_password_key
    monitored_conditions:
      - cpu_total_load
      - memory_real_usage
      - disk_smart_status
      - volume_status
      - volume_percentage_used
  - platform: snmp
    name: nas_name
    host: !secret synology_ip
    baseoid: 1.3.6.1.4.1.6574.1.5.1.0
    accept_errors: true
    scan_interval: 86400
  - platform: snmp
    name: nas_serial
    host: !secret synology_ip
    baseoid: 1.3.6.1.4.1.6574.1.5.2.0
    accept_errors: true
    scan_interval: 86400
  - platform: snmp
    name: nas_uptime
    host: !secret synology_ip
    baseoid: 1.3.6.1.2.1.25.1.1.0
    accept_errors: true
    scan_interval: 30
    value_template: >-
        {% set uptime = float(value) / 100 %}
        {% set updays = (uptime / 86400) | round(0, "floor") %}
        {% set uphours = uptime | timestamp_custom('%-H:%-M:%-S', false) | regex_replace('^0:','') %}
        {% if updays == 0 %}
            {{- uphours -}}
        {% elif updays == 1 %}
            {{- updays ~ " Day, " ~ uphours -}}
        {% else %}
            {{- updays ~ " Days, " ~ uphours -}}
        {% endif %}

  - platform: waqi
    token: !secret waqi_token_key
    locations: 'Toronto'

  - platform: template
    sensors:
      aqhi:
        value_template: "{{ states('sensor.air_quality_health_index') }}"
      aqi:
        value_template: "{{ states('sensor.waqi_toronto') }}"
      o3:
        value_template: "{{ state_attr('sensor.waqi_toronto', 'ozone') }}"
      pm:
        value_template: "{{ state_attr('sensor.waqi_toronto', 'pm_2_5') }}"
      no2:
        value_template: "{{ state_attr('sensor.waqi_toronto', 'nitrogen_dioxide') }}"
      co:
        value_template: "{{ state_attr('sensor.waqi_toronto', 'co') }}"
      so2:
        value_template: "{{ state_attr('sensor.waqi_toronto', 'sulfur_dioxide') }}"
      aqhi_friendly:
        friendly_name: AQHI
        icon_template: mdi:chemical-weapon
        value_template: >-
          {% set l = states('sensor.aqhi') | int %}
          {% if l <= 3 %} Low
          {% elif l <= 6 %} Moderate
          {% elif l <= 10 %} High
          {% elif l > 10 %} Hazardous
          {% endif %}
      aqi_friendly:
        friendly_name: AQI
        icon_template: mdi:chemical-weapon
        value_template: >-
          {% set l = states('sensor.aqi') | int %}
          {% if l <= 99 %} Low
          {% elif l <= 149 %} Moderate
          {% elif l <= 199 %} High
          {% elif l > 199 %} Hazardous
          {% endif %}
      o3_friendly:
        friendly_name: O₃
        icon_template: mdi:earth
        value_template: >-
          {% set l = states('sensor.o3') | int %}
          {% if l < 0 %} unknown
          {% elif l <= 54 %} Good
          {% elif l <= 70 %} Moderate
          {% elif l <= 85 %} Unhealthy
          {% elif l > 85 %} Hazardous
          {% endif %}
      pm_friendly:
        friendly_name: PM₂.₅
        icon_template: mdi:chart-bubble
        value_template: >-
          {% set l = states('sensor.pm') | int %}
          {% if l < 0 %} unknown
          {% elif l <= 50 %} Good
          {% elif l <= 100 %} Moderate
          {% elif l <= 300 %} Unhealthy
          {% elif l > 300 %} Hazardous
          {% endif %}
      no2_friendly:
        friendly_name: NO₂
        icon_template: mdi:car
        value_template: >-
          {% set l = states('sensor.no2') | int %}
          {% if l < 0 %} unknown
          {% elif l <= 50 %} Good
          {% elif l <= 100 %} Moderate
          {% elif l <= 200 %} Unhealthy
          {% elif l > 200 %} Hazardous
          {% endif %}
      co_friendly:
        friendly_name: CO
        icon_template: mdi:fire
        value_template: >-
          {% set l = states('sensor.co') | float %}
          {% if l < 0 %} unknown
          {% elif l <= 4.4 %} Good
          {% elif l <= 9.4 %} Moderate
          {% elif l <= 15.4 %} Unhealthy
          {% elif l > 15.4 %} Hazardous
          {% endif %}
      so2_friendly:
        friendly_name: SO₂
        icon_template: mdi:factory
        value_template: >-
          {% set l = states('sensor.so2') | int %}
          {% if l < 0 %} unknown
          {% elif l <= 34 %} Good
          {% elif l <= 144 %} Moderate
          {% elif l <= 304 %} Unhealthy
          {% elif l > 304 %} Hazardous
          {% endif %}
      cigarettes:
        friendly_name: Cigarettes / Day
        icon_template: mdi:smoking
        unit_of_measurement: 'Cigarettes'
        value_template: >-
          {% if states('sensor.pm').isdigit() %}
            {{ ( float(states('sensor.pm')) / 22 ) | round(1) }}
          {% else %}
            {{ float(0) }}
          {% endif %}

      ec_current_summary:
        friendly_name: Currently
        value_template: >-
          Currently {{ states('sensor.temperature') }}°C (Feels like {{ states('sensor.feels_like') }}) and {{ states('sensor.ec_current_summary_text') }}
        entity_picture_template: >-
          "https://weather.gc.ca/weathericons/{{ states('sensor.ec_current_icon') }}.gif"
        icon_template: >-
          mdi:thermometer
      ec_1_summary:
        friendly_name_template: >-
          {{ states('sensor.ec_1_name') }}
        value_template: >-
          {{ states('sensor.ec_1_summary_text') }}
        entity_picture_template: >-
          "https://weather.gc.ca/weathericons/{{ states('sensor.ec_1_icon') }}.gif"
      ec_2_summary:
        friendly_name_template: >-
          {{ states('sensor.ec_2_name') }}
        value_template: >-
          {{ states('sensor.ec_2_summary_text') }}
        entity_picture_template: >-
          "https://weather.gc.ca/weathericons/{{ states('sensor.ec_2_icon') }}.gif"
      ec_3_summary:
        friendly_name_template: >-
          {{ states('sensor.ec_3_name') }}
        value_template: >-
          {{ states('sensor.ec_3_summary_text') }}
        entity_picture_template: >-
          "https://weather.gc.ca/weathericons/{{ states('sensor.ec_3_icon') }}.gif"
      ec_4_summary:
        friendly_name_template: >-
          {{ states('sensor.ec_4_name') }}
        value_template: >-
          {{ states('sensor.ec_4_summary_text') }}
        entity_picture_template: >-
          "https://weather.gc.ca/weathericons/{{ states('sensor.ec_4_icon') }}.gif"
      ec_5_summary:
        friendly_name_template: >-
          {{ states('sensor.ec_5_name') }}
        value_template: >-
          {{ states('sensor.ec_5_summary_text') }}
        entity_picture_template: >-
          "https://weather.gc.ca/weathericons/{{ states('sensor.ec_5_icon') }}.gif"
      ec_6_summary:
        friendly_name_template: >-
          {{ states('sensor.ec_6_name') }}
        value_template: >-
          {{ states('sensor.ec_6_summary_text') }}
        entity_picture_template: >-
          "https://weather.gc.ca/weathericons/{{ states('sensor.ec_6_icon') }}.gif"

  - platform: miflora
    name: kitchen
    mac: !secret plant1_mac
    force_update: true
    monitored_conditions:
      - battery
      - conductivity
      - light
      - moisture
      - temperature

  - platform: nextbus
    agency: ttc
    route: 97
    stop: 8543
    scan_interval: 60
  - platform: template
    sensors:
      97north:
        friendly_name: '97 North'
        icon_template: mdi:bus-clock
        unit_of_measurement: 'min'
        value_template: '{{ state_attr("sensor.ttc_97", "upcoming").split(",")[0] }}'
