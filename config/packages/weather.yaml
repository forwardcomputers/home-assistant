# https://www.home-assistant.io/components/sensor.wunderground/
# https://www.home-assistant.io/components/sensor.yr/
# https://www.home-assistant.io/components/sensor.template/
# https://github.com/pnbruckner/homeassistant-config/blob/master/custom_components/sun.py
# https://github.com/andrey-git/home-assistant-custom-ui
# https://community.home-assistant.io/t/custom-ui-weather-state-card/23008/245

homeassistant:
  customize:
    sensor.environment_canada_radar:
      hidden: true
    sun.sun:
      hidden: true
    sensor.yr_cloudiness:
      hidden: true
    sensor.ec_warning:
      friendly_name: Weather Warning
      icon: mdi:alert
    sensor.ec_dewpoint:
      friendly_name: Dewpoint
      icon: mdi:water
    sensor.ec_humidex:
      friendly_name: Humidex
      icon: mdi:oil-temperature
    sensor.ec_pop:
      friendly_name: Probability of precipitation
      icon: weather-rainy
    sensor.ec_pressure:
      friendly_name: Pressure
      icon: mdi:gauge
    sensor.ec_relative_humidity:
      friendly_name: Outside humidity
      icon: mdi:water-percent
    sensor.ec_temperature:
      friendly_name: Outside temperature
      icon: mdi:thermometer
    sensor.ec_uv_index:
      friendly_name: UV index
      icon: mdi:sunglasses
    sensor.ec_visibility:
      friendly_name: Visibility
      icon: mdi:eye
    sensor.ec_wind_chill:
      friendly_name: Wind chill
      icon: mdi:snowman
    sensor.ec_wind_direction:
      friendly_name: Wind direction
      icon: compas
    sensor.ec_wind_gust:
      friendly_name: Wind gust
      icon: weather-windy
    sensor.ec_wind_speed:
      friendly_name: Wind speed
      icon: weather-windy

sun:
  monitored_conditions:
    - azimuth
    - elevation
    - next_dawn
    - next_dusk
    - next_midnight
    - next_noon
    - sunrise
    - sunset
  scan_interval:
    minutes: 1

weather:
  - platform: openweathermap
    api_key: !secret openweathermap_api_key
    mode: daily

sensor:
  - platform: command_line
    name: ec_warning
    command: "xmllint --xpath 'string(//warnings/event/@description)' /tmp/toronto.xml"
  - platform: command_line
    name: ec_current_summary_text
    command: "xmllint --xpath 'string(//currentConditions/condition)' /tmp/toronto.xml"
  - platform: command_line
    name: ec_current_icon
    command: "xmllint --xpath 'string(//currentConditions/iconCode)' /tmp/toronto.xml"
  - platform: command_line
    name: ec_temperature
    command: "xmllint --xpath 'string(//currentConditions/temperature)' /tmp/toronto.xml"
    unit_of_measurement: "째C"
  - platform: command_line
    name: ec_dewpoint
    command: "xmllint --xpath 'string(//currentConditions/dewpoint)' /tmp/toronto.xml"
    unit_of_measurement: "째C"
  - platform: command_line
    name: ec_humidex
    command: "xmllint --xpath 'string(//currentConditions/humidex)' /tmp/toronto.xml"
  - platform: command_line
    name: ec_wind_chill
    command: "xmllint --xpath 'string(//currentConditions/windChill)' /tmp/toronto.xml"
  - platform: command_line
    name: ec_pressure
    command: "xmllint --xpath 'string(//currentConditions/pressure)' /tmp/toronto.xml"
    unit_of_measurement: "kPa"
  - platform: command_line
    name: ec_visibility
    command: "xmllint --xpath 'string(//currentConditions/visibility)' /tmp/toronto.xml"
    unit_of_measurement: "km"
  - platform: command_line
    name: ec_relative_humidity
    command: "xmllint --xpath 'string(//currentConditions/relativeHumidity)' /tmp/toronto.xml"
    unit_of_measurement: "%"
  - platform: command_line
    name: ec_wind_speed
    command: "xmllint --xpath 'string(//currentConditions/wind/speed)' /tmp/toronto.xml"
    unit_of_measurement: "km/h"
  - platform: command_line
    name: ec_wind_gust
    command: "xmllint --xpath 'string(//currentConditions/wind/gust)' /tmp/toronto.xml"
    unit_of_measurement: "km/h"
  - platform: command_line
    name: ec_wind_direction
    command: "xmllint --xpath 'string(//currentConditions/wind/direction)' /tmp/toronto.xml"
  - platform: command_line
    name: ec_pop
    command: "xmllint --xpath 'string(//forecastGroup/forecast[1]/abbreviatedForecast/pop)' /tmp/toronto.xml"
    unit_of_measurement: "%"
  - platform: command_line
    name: ec_uv
    command: "xmllint --xpath 'string(//forecastGroup/forecast[1]/uv/@category)' /tmp/toronto.xml"
  - platform: command_line
    name: ec_uv_index
    command: "xmllint --xpath 'string(//forecastGroup/forecast[1]/uv/index)' /tmp/toronto.xml"
  - platform: command_line
    name: ec_1_name
    command: "xmllint --xpath 'string(//forecastGroup/forecast[1]/period)' /tmp/toronto.xml"
  - platform: command_line
    name: ec_1_icon
    command: "xmllint --xpath 'string(//forecastGroup/forecast[1]/abbreviatedForecast/iconCode)' /tmp/toronto.xml"
  - platform: command_line
    name: ec_1_summary_text
    command: "xmllint --xpath 'string(//forecastGroup/forecast[1]/textSummary)' /tmp/toronto.xml"
  - platform: command_line
    name: ec_2_name
    command: "xmllint --xpath 'string(//forecastGroup/forecast[2]/period)' /tmp/toronto.xml"
  - platform: command_line
    name: ec_2_icon
    command: "xmllint --xpath 'string(//forecastGroup/forecast[2]/abbreviatedForecast/iconCode)' /tmp/toronto.xml"
  - platform: command_line
    name: ec_2_summary_text
    command: "xmllint --xpath 'string(//forecastGroup/forecast[2]/textSummary)' /tmp/toronto.xml"
  - platform: command_line
    name: ec_3_name
    command: "xmllint --xpath 'string(//forecastGroup/forecast[3]/period)' /tmp/toronto.xml"
  - platform: command_line
    name: ec_3_icon
    command: "xmllint --xpath 'string(//forecastGroup/forecast[3]/abbreviatedForecast/iconCode)' /tmp/toronto.xml"
  - platform: command_line
    name: ec_3_summary_text
    command: "xmllint --xpath 'string(//forecastGroup/forecast[3]/textSummary)' /tmp/toronto.xml"
  - platform: command_line
    name: ec_4_name
    command: "xmllint --xpath 'string(//forecastGroup/forecast[4]/period)' /tmp/toronto.xml"
  - platform: command_line
    name: ec_4_icon
    command: "xmllint --xpath 'string(//forecastGroup/forecast[4]/abbreviatedForecast/iconCode)' /tmp/toronto.xml"
  - platform: command_line
    name: ec_4_summary_text
    command: "xmllint --xpath 'string(//forecastGroup/forecast[4]/textSummary)' /tmp/toronto.xml"
  - platform: command_line
    name: ec_5_name
    command: "xmllint --xpath 'string(//forecastGroup/forecast[5]/period)' /tmp/toronto.xml"
  - platform: command_line
    name: ec_5_icon
    command: "xmllint --xpath 'string(//forecastGroup/forecast[5]/abbreviatedForecast/iconCode)' /tmp/toronto.xml"
  - platform: command_line
    name: ec_5_summary_text
    command: "xmllint --xpath 'string(//forecastGroup/forecast[5]/textSummary)' /tmp/toronto.xml"
  - platform: command_line
    name: ec_6_name
    command: "xmllint --xpath 'string(//forecastGroup/forecast[6]/period)' /tmp/toronto.xml"
  - platform: command_line
    name: ec_6_icon
    command: "xmllint --xpath 'string(//forecastGroup/forecast[6]/abbreviatedForecast/iconCode)' /tmp/toronto.xml"
  - platform: command_line
    name: ec_6_summary_text
    command: "xmllint --xpath 'string(//forecastGroup/forecast[6]/textSummary)' /tmp/toronto.xml"

  # - platform: environment_canada
  #   monitored_conditions:
  #     - temperature
  #     - dewpoint
  #     - wind_chill
  #     - humidex
  #     - pressure
  #     - tendency
  #     - humidity
  #     - visibility
  #     - condition
  #     - wind_speed
  #     - wind_gust
  #     - wind_dir
  #     - high_temp
  #     - low_temp
  #     - pop
  #     - warning
  #     - weather_1d
  #     - weather_1n
  - platform: yr
    monitored_conditions:
      - cloudiness
  - platform: template
    sensors:
      thermostat_temperature:
        friendly_name: Indoor temperature
        value_template: '{{ states.climate.thermostat.attributes.current_temperature }}'
        icon_template: >-
          mdi:thermometer
      thermostat_humidity:
        friendly_name: Indoor humidity
        value_template: '{{ states.climate.thermostat.attributes.current_humidity }}'
        icon_template: >-
          mdi:water-percent
      # ec_warning_alert:
      #   friendly_name: Weather Warning
      #   value_template: >-
      #     {% if is_state('sensor.ec_warning', '') %}
      #       NONE
      #     {% endif %}
      #   icon_template: >-
      #     mdi:alert
      ec_feels_like:
        friendly_name: Feels like
        value_template: >-
          {% if not is_state('sensor.ec_wind_chill', '') %}
            {{ states('sensor.ec_wind_chill') }}
          {% elif not is_state('sensor.ec_humidex', '') %}
            {{ states('sensor.ec_humidex') }}
          {% else %}
            {{ states('sensor.ec_temperature') }}째C 
          {% endif %}
      ec_current_summary:
        friendly_name: Currently
        value_template: >-
          Currently {{ states('sensor.ec_temperature') }}째C (Feels like {{ states('sensor.ec_feels_like') }}) and {{ states('sensor.ec_current_summary_text') }}
        entity_picture_template: >-
          "https://weather.gc.ca/weathericons/{{ states('sensor.ec_current_icon') }}.gif"
        icon_template: >-
          mdi:thermometer
      ec_1_summary:
        friendly_name_template: >-
          {{ states('sensor.ec_1_name') }}
        value_template: >-
          {{ states('sensor.ec_1_summary_text') }}
        entity_picture_template: >-
          "https://weather.gc.ca/weathericons/{{ states('sensor.ec_1_icon') }}.gif"
      ec_2_summary:
        friendly_name_template: >-
          {{ states('sensor.ec_2_name') }}
        value_template: >-
          {{ states('sensor.ec_2_summary_text') }}
        entity_picture_template: >-
          "https://weather.gc.ca/weathericons/{{ states('sensor.ec_2_icon') }}.gif"
      ec_3_summary:
        friendly_name_template: >-
          {{ states('sensor.ec_3_name') }}
        value_template: >-
          {{ states('sensor.ec_3_summary_text') }}
        entity_picture_template: >-
          "https://weather.gc.ca/weathericons/{{ states('sensor.ec_3_icon') }}.gif"
      ec_4_summary:
        friendly_name_template: >-
          {{ states('sensor.ec_4_name') }}
        value_template: >-
          {{ states('sensor.ec_4_summary_text') }}
        entity_picture_template: >-
          "https://weather.gc.ca/weathericons/{{ states('sensor.ec_4_icon') }}.gif"
      ec_5_summary:
        friendly_name_template: >-
          {{ states('sensor.ec_5_name') }}
        value_template: >-
          {{ states('sensor.ec_5_summary_text') }}
        entity_picture_template: >-
          "https://weather.gc.ca/weathericons/{{ states('sensor.ec_5_icon') }}.gif"
      ec_6_summary:
        friendly_name_template: >-
          {{ states('sensor.ec_6_name') }}
        value_template: >-
          {{ states('sensor.ec_6_summary_text') }}
        entity_picture_template: >-
          "https://weather.gc.ca/weathericons/{{ states('sensor.ec_6_icon') }}.gif"
      indoor_humidity:
        friendly_name: 'Indoor Humidity'
        unit_of_measurement: '%'
        icon_template: mdi:water-percent
        value_template: '{{ states.climate.thermostat.attributes.current_humidity | int }}'
      sunrise_time:
        friendly_name: Sunrise
        unit_of_measurement: AM
        icon_template: mdi:weather-sunset-up
        value_template: '{{ as_timestamp(states.sun.sun.attributes.next_dawn) | timestamp_custom("%-I:%M") }}'
      sunset_time:
        friendly_name: Sunset
        unit_of_measurement: PM
        icon_template: mdi:weather-sunset-down
        value_template: '{{ as_timestamp(states.sun.sun.attributes.next_dusk) | timestamp_custom("%-I:%M") }}'
      environment_canada_radar:
        friendly_name: Environment Canada Radar
        value_template: WKR

shell_command:
  download_ec_forecast_toronto: curl -s --retry 3 --output /tmp/toronto.xml http://dd.weatheroffice.ec.gc.ca/citypage_weather/xml/ON/s0000458_e.xml

automation:
  - id: download_ec_forecast
    alias: Download EC forecast
    initial_state: on
    trigger:
      - platform: homeassistant
        event: start
      - platform: time_pattern
        minutes: 30
    action:
      - service: shell_command.download_ec_forecast_toronto
